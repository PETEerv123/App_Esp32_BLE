<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web BLE ECG Monitor</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
* { box-sizing: border-box; }
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 20px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    min-height: 100vh;
    padding: 20px;
}
.container {
    max-width: 800px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}
h2, h3 { 
    color: white; 
    text-align: center;
    margin-bottom: 20px;
}
h2 { font-size: 2.2em; margin-top: 0; }
h3 { font-size: 1.4em; border-bottom: 2px solid rgba(255, 255, 255, 0.3); padding-bottom: 10px; }
button { 
    margin: 10px; 
    padding: 15px 30px; 
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
button:active { transform: translateY(1px); }
#scanBtn { 
    background: linear-gradient(45deg, #4CAF50, #2E7D32);
    color: white;
}
#disconnectBtn { 
    background: linear-gradient(45deg, #F44336, #C62828);
    color: white;
}
#disconnectBtn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
}
.buttons {
    text-align: center;
    margin: 30px 0;
}
.info-box {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    padding: 20px;
    margin: 15px 0;
    transition: all 0.3s;
}
.info-box:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}
.info-label {
    font-weight: bold;
    color: #ffcc00;
    display: inline-block;
    width: 180px;
}
.info-value {
    font-family: 'Courier New', monospace;
    word-break: break-all;
}
.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
    vertical-align: middle;
}
.connected { background-color: #4CAF50; box-shadow: 0 0 10px #4CAF50; }
.disconnected { background-color: #F44336; box-shadow: 0 0 10px #F44336; }
.connecting { background-color: #FF9800; box-shadow: 0 0 10px #FF9800; animation: pulse 1s infinite; }
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
#dataArea {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 20px;
    height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    margin-top: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}
#ecgChart {
    width: 100%;
    height: 300px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    margin-top: 20px;
}
.data-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}
.heart-rate {
    font-size: 2.5em;
    font-weight: bold;
    color: #ff4444;
    text-align: center;
    margin: 20px 0;
    animation: heartbeat 1.5s ease-in-out infinite;
}
@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
.battery {
    display: inline-block;
    padding: 5px 15px;
    background: linear-gradient(45deg, #4CAF50, #2E7D32);
    border-radius: 20px;
    font-weight: bold;
}
</style>
</head>

<body>
<div class="container">
    <h2>‚ù§Ô∏è Web BLE ECG Monitor</h2>
    
    <div class="buttons">
        <button id="scanBtn">
            <span style="margin-right: 8px;">üîç</span> SCAN BLE DEVICES
        </button>
        <button id="disconnectBtn" disabled>
            <span style="margin-right: 8px;">‚ùå</span> DISCONNECT
        </button>
    </div>

    <h3>üì° Device Information</h3>
    <div class="info-box">
        <div class="data-row">
            <span class="info-label">Status:</span>
            <span class="info-value">
                <span id="statusIndicator" class="status-indicator disconnected"></span>
                <span id="statusText">Disconnected</span>
            </span>
        </div>
        <div class="data-row">
            <span class="info-label">Device Name:</span>
            <span class="info-value" id="deviceName">Not connected</span>
        </div>
        <div class="data-row">
            <span class="info-label">Device ID:</span>
            <span class="info-value" id="deviceId">-</span>
        </div>
        <div class="data-row">
            <span class="info-label">Service UUID:</span>
            <span class="info-value" id="serviceUUID">0x0259 (Heart Rate)</span>
        </div>
        <div class="data-row">
            <span class="info-label">Characteristic UUID:</span>
            <span class="info-value" id="charUUID">0x2A37 (Heart Rate Measurement)</span>
        </div>
    </div>

    <h3>üíì Real-time Data</h3>
    <div class="info-box">
        <div class="heart-rate" id="heartRateDisplay">--</div>
        <div class="data-row">
            <span class="info-label">Battery Level:</span>
            <span class="info-value"><span class="battery" id="batteryLevel">--%</span></span>
        </div>
        <div class="data-row">
            <span class="info-label">RR Interval:</span>
            <span class="info-value" id="rrInterval">-- ms</span>
        </div>
        <div class="data-row">
            <span class="info-label">Accelerometer:</span>
            <span class="info-value" id="accelValue">-- g</span>
        </div>
        <div class="data-row">
            <span class="info-label">Samples Received:</span>
            <span class="info-value" id="sampleCount">0</span>
        </div>
    </div>

    <h3>üìä ECG Data Stream</h3>
    <div id="dataArea">Waiting for ECG data...</div>

    <!-- Canvas for ECG Chart (optional) -->
    <canvas id="ecgChart"></canvas>
</div>

<script>
// UUID Configuration
const SERVICE_UUID = 0x0259;           // 16-bit Heart Rate Service UUID
const CHAR_UUID = 0x2A37;              // 16-bit Heart Rate Measurement Characteristic

// Global variables
let device = null;
let server = null;
let service = null;
let characteristic = null;
let sampleCounter = 0;
let ecgData = [];

// DOM Elements
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const deviceName = document.getElementById('deviceName');
const deviceId = document.getElementById('deviceId');
const heartRateDisplay = document.getElementById('heartRateDisplay');
const batteryLevel = document.getElementById('batteryLevel');
const rrInterval = document.getElementById('rrInterval');
const accelValue = document.getElementById('accelValue');
const sampleCount = document.getElementById('sampleCount');
const dataArea = document.getElementById('dataArea');
const scanBtn = document.getElementById('scanBtn');
const disconnectBtn = document.getElementById('disconnectBtn');

// Update status display
function updateStatus(status, isConnected = false) {
    statusText.textContent = status;
    statusIndicator.className = 'status-indicator ' + 
        (isConnected ? 'connected' : (status === 'Connecting...' ? 'connecting' : 'disconnected'));
}

// Parse ECG data from BLE notification
function parseECGData(dataView) {
    try {
        let offset = 0;
        
        // Heart Rate (2 bytes, little-endian)
        const hr = dataView.getUint16(offset, true);
        offset += 2;
        
        // RR Interval (2 bytes, little-endian)
        const rr = dataView.getUint16(offset, true);
        offset += 2;
        
        // Battery Level (1 byte)
        const battery = dataView.getUint8(offset);
        offset += 1;
        
        // Accelerometer (2 bytes, little-endian)
        const accel = dataView.getUint16(offset, true) / 1000.0;
        offset += 2;
        
        // ECG Samples (rest of the data, each sample 4 bytes)
        const ecgSamples = [];
        const numSamples = (dataView.byteLength - offset) / 4;
        
        for (let i = 0; i < numSamples; i++) {
            const sample = dataView.getInt32(offset, true);
            ecgSamples.push(sample);
            offset += 4;
        }
        
        return {
            heartRate: hr,
            rrInterval: rr,
            battery: battery,
            accelerometer: accel,
            ecgSamples: ecgSamples,
            timestamp: new Date().toLocaleTimeString()
        };
    } catch (error) {
        console.error('Error parsing ECG data:', error);
        return null;
    }
}

// Display ECG data
function displayECGData(ecgData) {
    // Update real-time values
    heartRateDisplay.textContent = ecgData.heartRate;
    batteryLevel.textContent = ecgData.battery + '%';
    rrInterval.textContent = ecgData.rrInterval + ' ms';
    accelValue.textContent = ecgData.accelerometer.toFixed(3) + ' g';
    
    // Update sample counter
    sampleCounter += ecgData.ecgSamples.length;
    sampleCount.textContent = sampleCounter;
    
    // Display raw data
    const dataStr = `[${ecgData.timestamp}] HR: ${ecgData.heartRate} bpm | RR: ${ecgData.rrInterval} ms | Battery: ${ecgData.battery}% | Accel: ${ecgData.accelerometer.toFixed(3)} g\n` +
                   `ECG Samples: ${ecgData.ecgSamples.length} samples\n` +
                   `First sample: ${ecgData.ecgSamples[0]}, Last: ${ecgData.ecgSamples[ecgData.ecgSamples.length-1]}\n` +
                   '‚îÄ'.repeat(50) + '\n';
    
    dataArea.textContent = dataStr + dataArea.textContent;
    
    // Keep only last 20 entries
    const lines = dataArea.textContent.split('\n');
    if (lines.length > 100) {
        dataArea.textContent = lines.slice(0, 100).join('\n');
    }
}

// Handle BLE connection
scanBtn.onclick = async () => {
    try {
        updateStatus('Scanning...');
        
        // Request BLE device
        device = await navigator.bluetooth.requestDevice({
            filters: [
                { name: 'ECG Device' },  // Filter by device name
                { services: [SERVICE_UUID] }  // Filter by service UUID
            ],
            optionalServices: [SERVICE_UUID]
        });
        
        deviceName.textContent = device.name || 'Unknown Device';
        deviceId.textContent = device.id;
        updateStatus('Connecting...');
        
        // Handle disconnection
        device.addEventListener('gattserverdisconnected', () => {
            updateStatus('Disconnected');
            disconnectBtn.disabled = true;
            scanBtn.disabled = false;
        });
        
        // Connect to GATT server
        server = await device.gatt.connect();
        updateStatus('Connected', true);
        
        // Get service
        service = await server.getPrimaryService(SERVICE_UUID);
        
        // Get characteristic
        characteristic = await service.getCharacteristic(CHAR_UUID);
        
        // Start notifications
        await characteristic.startNotifications();
        
        // Handle incoming data
        characteristic.addEventListener('characteristicvaluechanged', event => {
            const value = event.target.value;
            const ecgData = parseECGData(value);
            
            if (ecgData) {
                displayECGData(ecgData);
            }
        });
        
        // Enable disconnect button
        disconnectBtn.disabled = false;
        scanBtn.disabled = true;
        
    } catch (error) {
        updateStatus('Error: ' + error.message);
        console.error('Bluetooth error:', error);
    }
};

// Handle disconnection
disconnectBtn.onclick = () => {
    if (device && device.gatt.connected) {
        device.gatt.disconnect();
    }
    updateStatus('Disconnected');
    disconnectBtn.disabled = true;
    scanBtn.disabled = false;
};

// Initialize
updateStatus('Disconnected');
</script>
</body>
</html>
