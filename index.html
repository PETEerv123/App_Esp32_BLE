<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web BLE Scanner</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        padding: 20px;
    }
    h2 { color: #3f51b5; }
    button {
        padding: 10px 16px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 8px;
    }
    #scanBtn { background: #2ecc71; color:white; }
    #disconnectBtn { background: #e74c3c; color:white; }

    ul {
        background: white;
        padding: 10px;
        border-radius: 10px;
        list-style: none;
    }
    li {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
    }
    li:hover { background: #eef; }
    
    .label { font-weight: bold; }
</style>
</head>

<body>

<h2>üîµ Web Bluetooth Scanner</h2>

<button id="scanBtn">SCAN BLE</button>
<button id="disconnectBtn" disabled>Disconnect</button>

<h3>üì° Scan result:</h3>
<ul id="deviceList"></ul>

<h3>üîß Connection Info:</h3>
<p><span class="label">Status:</span> <span id="status">Disconnected</span></p>
<p><span class="label">Device Name:</span> <span id="devName">None</span></p>
<p><span class="label">Device ID:</span> <span id="devId">None</span></p>
<p><span class="label">Service UUID:</span> <span id="serviceUUID">None</span></p>
<p><span class="label">Characteristic UUID:</span> <span id="charUUID">None</span></p>

<h3>üì• Characteristic Receive:</h3>
<pre id="receivedData" style="background:#fff;padding:10px;border-radius:8px;">No data...</pre>

<script>

let device = null;
let server = null;
let characteristic = null;

document.getElementById("scanBtn").onclick = async () => {
    try {
        const devList = document.getElementById("deviceList");
        devList.innerHTML = ""; 

        console.log("Requesting Bluetooth devices...");
        device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ["battery_service", "device_information"] // qu√©t t·∫•t c·∫£
        });

        // hi·ªÉn th·ªã 1 thi·∫øt b·ªã ‚Üí click l√† connect lu√¥n
        const li = document.createElement("li");
        li.textContent = device.name || "Unknown Device";
        li.onclick = () => connectToDevice(device);
        devList.appendChild(li);

    } catch (err) {
        alert("Error: " + err);
    }
};

async function connectToDevice(device) {
    try {
        updateStatus("Connecting...");

        server = await device.gatt.connect();
        updateStatus("Connected");

        document.getElementById("devName").innerText = device.name || "Unknown";
        document.getElementById("devId").innerText = device.id;

        document.getElementById("disconnectBtn").disabled = false;

        // L·∫•y service
        const services = await server.getPrimaryServices();
        if (services.length === 0) {
            alert("No services found!");
            return;
        }

        let service = services[0];
        document.getElementById("serviceUUID").innerText = service.uuid;

        // L·∫•y characteristic ƒë·∫ßu ti√™n
        const characteristics = await service.getCharacteristics();
        characteristic = characteristics[0];

        document.getElementById("charUUID").innerText = characteristic.uuid;

        // k√≠ch ho·∫°t Notify n·∫øu c√≥
        try {
            await characteristic.startNotifications();
            characteristic.addEventListener("characteristicvaluechanged", onNotification);
        } catch (e) {
            console.log("Notify not supported");
        }

        // ƒë·ªçc 1 l·∫ßn
        const value = await characteristic.readValue();
        parseValue(value);

    } catch (err) {
        alert("Connection error:\n" + err);
        updateStatus("Disconnected");
    }
}

function onNotification(event) {
    const value = event.target.value;
    parseValue(value);
}

function parseValue(dataView) {
    let text = "";
    for (let i = 0; i < dataView.byteLength; i++) {
        text += dataView.getUint8(i).toString(16).padStart(2, "0") + " ";
    }
    document.getElementById("receivedData").innerText = text;
}

document.getElementById("disconnectBtn").onclick = () => {
    if (!device) return;
    device.gatt.disconnect();
    updateStatus("Disconnected");
};

function updateStatus(msg) {
    document.getElementById("status").innerText = msg;
}

</script>
</body>
</html>
